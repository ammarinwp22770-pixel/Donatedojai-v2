<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Permissions-Policy" content="autoplay=*">
  <title>üíñ H0LLoWx Donate Alert üíñ</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --neon: #69eaff;
      --neon2: #47b3ff;
      --bg: #0b1020;
      --text: #e9f3ff;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: transparent;
      color: var(--text);
      font-family: "Prompt", sans-serif;
    }

    .alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: radial-gradient(circle at top left, #132043, #0b1020);
      border: 2.5px solid var(--neon2);
      border-radius: 25px;
      padding: 36px 60px;
      text-align: center;
      font-size: 30px;
      color: var(--text);
      box-shadow: 0 0 60px var(--neon2);
      opacity: 0;
      animation: popIn 1s ease forwards, floaty 2s ease-in-out 1s infinite alternate;
    }

    @keyframes popIn {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.6);
      }

      60% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.1);
      }

      100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
    }

    @keyframes floaty {
      0% {
        transform: translate(-50%, -48%) scale(1);
      }

      100% {
        transform: translate(-50%, -52%) scale(1.03);
      }
    }

    .particle {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--neon);
      border-radius: 50%;
      pointer-events: none;
      opacity: 0.9;
      filter: blur(2px);
    }
  </style>
</head>

<body>

  <script>
    // ‚úÖ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OBS/Chrome)
    window.addEventListener("load", async () => {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        gain.gain.value = 0;
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.05);
        await ctx.resume();
        console.log("üîì Audio unlocked successfully!");
      } catch (err) {
        console.warn("‚ö†Ô∏è Autoplay unlock failed:", err);
      }
    });

    // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö WebSocket
    const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws");

    let alertQueue = [];
    let isPlaying = false;
    let alertConfig = {};

    const preload = new Audio("alert.mp3");
    preload.volume = 0;
    preload.play().catch(() => { });

    ws.onopen = () => console.log("‚úÖ OBS Alert Connected");
    ws.onerror = err => console.error("‚ö†Ô∏è WebSocket Error:", err);

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å server
    ws.addEventListener("message", (e) => {
      const data = JSON.parse(e.data);
      console.log("üì® ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", data);

      if (data.type === "donate") {
        enqueueAlert(data.name, data.amount, data.comment || "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô üíñ");
      }
      if (data.type === "alert_test") {
        enqueueAlert(data.name, data.amount, data.comment || "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Alert üíñ");
      }
      if (data.type === "config_update") {
        alertConfig = data.config;
        console.log("üîÑ Config updated:", alertConfig);
      }
    });

    // üì¶ ‡πÉ‡∏™‡πà‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà
    function enqueueAlert(name, amount, comment) {
      alertQueue.push({ name, amount, comment });
      if (!isPlaying) playNextAlert();
    }

    // ‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô alert ‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß
    async function playNextAlert() {
      if (alertQueue.length === 0) return;
      isPlaying = true;

      const { name, amount, comment } = alertQueue.shift();
      await showAlert(name, amount, comment);

      isPlaying = false;
      if (alertQueue.length > 0) playNextAlert();
    }

    // üé¨ ‡πÅ‡∏™‡∏î‡∏á alert + ‡πÄ‡∏™‡∏µ‡∏¢‡∏á + ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå
    async function showAlert(name, amount, comment = "") {
      return new Promise(async (resolve) => {
        const box = document.createElement("div");
        box.className = "alert";
        box.style.borderColor = alertConfig.color || "#69eaff";

        box.innerHTML = `
        <img src="${alertConfig.popupImage?.startsWith('/uploads/') ? alertConfig.popupImage : '/uploads/' + (alertConfig.popupImage || 'default.png')}" width="120"><br>
        üåü <b style="color:${alertConfig.nameColor || '#ff5ca1'};">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì ${name}</b><br>
        ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô <b style="color:${alertConfig.amountColor || '#47ffa1'};">${amount} ‡∏ö‡∏≤‡∏ó!</b><br>
        <span style="font-size:18px;color:${alertConfig.commentColor || '#a7b8ff'};">${comment}</span>
      `;
        document.body.appendChild(box);

        // üîä ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á alert
        const sound = new Audio(alertConfig.sound || "alert.mp3");
        sound.volume = 0.9;
        sound.onended = async () => {
          await new Promise(r => setTimeout(r, 300));
          await generateTTS(`‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì ${name} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô ${amount} ‡∏ö‡∏≤‡∏ó ${comment || ""}`);
          resolve();
        };
        await sound.play().catch(err => console.error("‚ùå ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err));

        // üåà ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ
        for (let i = 0; i < 30; i++) {
          const p = document.createElement("div");
          p.className = "particle";
          p.style.left = "50%";
          p.style.top = "50%";
          p.style.background = `hsl(${Math.random() * 360},100%,70%)`;
          document.body.appendChild(p);
          const x = (Math.random() - 0.5) * 800;
          const y = (Math.random() - 0.5) * 600;
          const time = 1800 + Math.random() * 1500;
          p.animate([
            { transform: `translate(0,0) scale(1)`, opacity: 1 },
            { transform: `translate(${x}px,${y}px) scale(0.3)`, opacity: 0 }
          ], { duration: time, easing: "ease-out" });
          setTimeout(() => p.remove(), time);
        }

        // ‚è≥ ‡∏•‡∏ö alert ‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥
        setTimeout(() => {
          box.style.animation = "fadeOut 1.5s forwards";
          setTimeout(() => box.remove(), 1500);
        }, 5000);
      });
    }

    // üó£Ô∏è Google TTS
    async function generateTTS(text) {
      try {
        const apiKey = "AIzaSyAZBK3w7-bz8vNJHG3638buKoRRBRQDMWU";
        const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`;
        const body = {
          input: { text },
          voice: { languageCode: "th-TH", name: "th-TH-Standard-A" },
          audioConfig: { audioEncoding: "MP3", speakingRate: 0.9 }
        };

        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if (!data.audioContent) throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å Google TTS");

        const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
        audio.volume = 1.0;
        await new Promise(r => setTimeout(r, 150));
        audio.oncanplaythrough = () => audio.play().catch(err => console.error("‚ùå ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err));
        audio.load();

      } catch (err) {
        console.error("‚ùå generateTTS Error:", err);
      }
    }

    // üß© ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏ö (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
    window.addEventListener("click", async () => {
      const s = new Audio("alert.mp3");
      s.volume = 1.0;
      await s.play();
      console.log("‚úÖ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    });
  </script>
</body>

</html>